!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.YytConnect=t():e.YytConnect=t()}(window,(function(){return function(e){var t={};function s(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,s),a.l=!0,a.exports}return s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(r,a,function(t){return e[t]}.bind(null,a));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){e.exports=s(1)},function(e,t,s){"use strict";s.r(t);class r{constructor(e,t){this.connect=e,this.mediaStream=new MediaStream,this.audioTrack=null,this.videoTrack=null,this.audioSender=null,this.videoSender=null,this.streamName=void 0===t?this.mediaStream.id:t}Id(){return this.mediaStream.id}Name(){return this.streamName}MediaStream(){return this.mediaStream}changeVideoStatus(e){if(null!=this.videoTrack){let t="";e?(t="ResumeStreamToUser",this.videoTrack.enabled=!0):(t="PauseStreamToUser",this.videoTrack.enabled=!1);const s={0:this.Id(),1:"video",2:"this"};this.connect.createMsgWebrtcMethod(t,s,e=>{})}}changeAudioStatus(e){if(null!=this.audioTrack){let t="";e?(t="ResumeStreamToUser",this.audioTrack.enabled=!0):(t="PauseStreamToUser",this.audioTrack.enabled=!1);const s={0:this.Id(),1:"audio",2:"this"};this.connect.createMsgWebrtcMethod(t,s,e=>{})}}createAudio(){const e=this;return new Promise((t,s)=>{if(null==e.audioTrack){const r={video:!1,audio:!0};navigator.mediaDevices.getUserMedia(r).then(s=>{s.getTracks().forEach(t=>{"audio"==t.kind&&(e.audioTrack=t)}),s.removeTrack(e.audioTrack),e.mediaStream.addTrack(e.audioTrack),t()}).catch(e=>{s(e)})}else s()})}createVideo(e,t,s){const r=this;return new Promise((a,n)=>{if(null==r.videoTrack){const o={video:{width:{exact:e},height:{exact:t},frameRate:s},audio:!1};navigator.mediaDevices.getUserMedia(o).then(e=>{e.getTracks().forEach(e=>{"video"==e.kind&&(r.videoTrack=e)}),e.removeTrack(r.videoTrack),r.mediaStream.addTrack(r.videoTrack),a()}).catch(e=>{n(e)})}else n()})}createScreen(e,t,s){const r=this;return new Promise((a,n)=>{if(null==r.videoTrack){const o={video:{width:e,height:t,frameRate:s}};navigator.mediaDevices.getDisplayMedia(o).then(e=>{e.getTracks().forEach(e=>{"video"==e.kind&&(r.videoTrack=e)}),e.removeTrack(r.videoTrack),r.mediaStream.addTrack(r.videoTrack),a()}).catch(e=>{n(e)})}else n()})}sendStreamToTag(...e){const t=this;return new Promise(async(s,r)=>{const a={0:e,1:t.Id(),2:"this"};t.connect.createMsgWebrtcMethod("SendStreamToTag",a,e=>{200==e.code?s({code:e.code,data:e.data}):r(new Error(JSON.stringify({code:e.code,errMsg:e.errMsg})))})})}getStreamInfo(){const e=this;return new Promise(async(t,s)=>{e.connect.createMsgWebrtcMethod("GetStreamInfo",{0:"this"},e=>{200==e.code?t({code:e.code,data:e.data}):s(new Error(JSON.stringify({code:e.code,errMsg:e.errMsg})))})})}getUserStreamInfo(...e){const t=this;return new Promise(async(s,r)=>{const a={0:e,1:"this"};t.connect.createMsgWebrtcMethod("GetUserStreamInfo",a,e=>{console.log("getUserStreamInfo",e),200==e.code?s({code:e.code,data:e.data}):r(new Error(JSON.stringify({code:e.code,errMsg:e.errMsg})))})})}sendStreamStopToTag(...e){const t=this;return new Promise(async(s,r)=>{const a={0:e,1:t.Id(),2:t.Name(),3:"this"};t.connect.createMsgWebrtcMethod("SendStreamStopToTag",a,e=>{200==e.code?s({code:e.code,data:e.data}):r(new Error(JSON.stringify({code:e.code,errMsg:e.errMsg})))})})}changeStreamName(e){this.streamName=e;const t=this;return new Promise(async(e,s)=>{const r={0:t.Id(),1:t.Name(),2:"this"};t.connect.createMsgWebrtcMethod("ChangeStreamName",r,t=>{200==t.code?e({code:t.code,data:t.data}):s(new Error(JSON.stringify({code:t.code,errMsg:t.errMsg})))})})}push(){const e=this;return new Promise(async(t,s)=>{const r=e.connect.localConnection;null!=e.audioTrack&&(e.audioSender=r.addTrack(e.audioTrack,e.mediaStream)),null!=e.videoTrack&&(e.videoSender=r.addTrack(e.videoTrack,e.mediaStream));const a=await this.connect.getOffer(),n={0:JSON.stringify(a),1:"this"};e.connect.createMsgWebrtcMethod("UpdateSdp",n,r=>{if(200==r.code){const a=JSON.parse(r.data);e.connect.setSdp(a).then(()=>{setTimeout(()=>{try{let s=e.changeStreamName(e.Name());t(s)}catch(e){s(e)}},200)}).catch(e=>{s(e)})}else s(new Error(JSON.stringify({code:r.code,errMsg:r.errMsg})))})})}stopPush(){const e=this;return new Promise(async(t,s)=>{const r=e.connect.localConnection;null!=e.audioSender&&r.removeTrack(e.audioSender),null!=e.videoSender&&r.removeTrack(e.videoSender);const a=await this.connect.getOffer(),n={0:JSON.stringify(a),1:"this"};e.connect.createMsgWebrtcMethod("UpdateSdp",n,r=>{if(200==r.code){const s=JSON.parse(r.data);e.connect.setSdp(s),t({code:r.code})}else s(new Error(JSON.stringify({code:r.code,errMsg:r.errMsg})))})})}close(){if(null!=this.audioTrack){this.mediaStream.removeTrack(this.audioTrack);try{this.audioTrack.close(),this.audioTrack.dispose()}catch(e){console.log("停止音频错误",e)}}if(null!=this.videoTrack){this.mediaStream.removeTrack(this.videoTrack);try{this.videoTrack.stop(),this.videoTrack.dispose()}catch(e){console.log("停止视频错误",e)}}try{this.mediaStream.dispose()}catch(e){console.log("停止mediaStream错误",e)}}}class a{constructor(e){this.connect=e}callback(e,t,s){200==e.code?t({code:200,data:e.data}):s(e)}AddTagsUser(...e){const t=this,s={0:e,1:"this"};return new Promise((e,r)=>{t.connect.createMsgTags("AddTagsUser",s,s=>{t.callback(s,e,r)})})}DelTagsUser(...e){const t=this,s={0:e,1:"this"};return new Promise((e,r)=>{t.connect.createMsgTags("DelTagsUser",s,s=>{t.callback(s,e,r)})})}CheckUserInTag(...e){const t=this,s={0:e,1:"this"};return new Promise((e,r)=>{t.connect.createMsgTags("CheckUserInTag",s,s=>{t.callback(s,e,r)})})}CheckOtherUserInTag(e,...t){const s=this,r={0:t,1:e};return new Promise((e,t)=>{s.connect.createMsgTags("CheckOtherUserInTag",r,r=>{s.callback(r,e,t)})})}CheckTagIsCreate(...e){const t=this,s={0:e};return new Promise((e,r)=>{t.connect.createMsgTags("CheckTagIsCreate",s,s=>{t.callback(s,e,r)})})}ClearTags(...e){const t=this,s={0:e};return new Promise((e,r)=>{t.connect.createMsgTags("ClearTags",s,s=>{t.callback(s,e,r)})})}TagsInUsers(...e){const t=this,s={0:e};return new Promise((e,r)=>{t.connect.createMsgTags("TagsInUsers",s,s=>{t.callback(s,e,r)})})}TagsSetData(e,...t){const s=this,r={0:t,1:e};return new Promise((e,t)=>{s.connect.createMsgTags("TagsSetData",r,r=>{s.callback(r,e,t)})})}TagsGetData(...e){const t=this,s={0:e};return new Promise((e,r)=>{t.connect.createMsgTags("TagsGetData",s,s=>{t.callback(s,e,r)})})}Data(){const e=this,t={0:"this"};return new Promise((s,r)=>{e.connect.createMsgUserMethod("Data",t,t=>{e.callback(t,s,r)})})}InitUserBean(e){const t=this,s={0:e,1:"this"};return new Promise((e,r)=>{t.connect.createMsgUserMethod("InitUserBean",s,s=>{t.callback(s,e,r)})})}UserData(e){const t=this,s={0:e};return new Promise((e,r)=>{t.connect.createMsgUserMethod("UserData",s,s=>{t.callback(s,e,r)})})}SendMessageBus(e,...t){const s=this,r={0:t,1:e,2:"this"};return new Promise((e,t)=>{s.connect.createMsgUserMethod("SendMessageBus",r,r=>{s.callback(r,e,t)})})}SendMessageTagBus(e,...t){const s=this,r={0:t,1:e,2:"this"};return new Promise((e,t)=>{s.connect.createMsgUserMethod("SendMessageTagBus",r,r=>{s.callback(r,e,t)})})}}class n{constructor(e){this.connect=e,this.streamMap=new Map,this.availableSize=0}streamMessage(e){}onTrack(e,t,s){}removeTrack(e,t,s){}_ontrack(e){const t=this;e.streams.forEach(e=>{if(!t.streamMap.has(e.id)){t.streamMap.set(e.id,e);e.getTracks().forEach(s=>{t.onTrack(s,e.id,e)})}})}message(e){7==e.info&&this.stopPullStream(e.data),this.streamMessage(e)}callback(e,t,s){200==e.code?t(e):s(e)}stopPullStream(e){const t=this;return new Promise(async(s,r)=>{const a=await this.connect.getOffer();null==a&&r(new Error("offer fail"));const n={0:e,1:!0,2:!0,3:JSON.stringify(a),4:"this"};t.connect.createMsgWebrtcMethod("StopPullStream",n,a=>{if(200==a.code){t.connect.setSdp(JSON.parse(a.data));const s=t.streamMap.get(e);if(null!=s){t.streamMap.delete(e);s.getTracks().forEach(e=>{t.removeTrack(e,s.id)})}}t.callback(a,s,r)})})}pullStream(e,t){const s=this;return new Promise(async(r,a)=>{s.availableSize<=s.streamMap.size&&(s.connect.localConnection.addTransceiver("video"),s.connect.localConnection.addTransceiver("audio"),s.availableSize++);const n=await s.connect.getOffer();null==n&&a(new Error("offer fail"));const o={0:e,1:t,2:!0,3:!0,4:JSON.stringify(n),5:"this"};s.connect.createMsgWebrtcMethod("PullStream",o,e=>{200==e.code&&s.connect.setSdp(JSON.parse(e.data)),s.callback(e,r,a)})})}}class o{constructor(e){this.id=e,this.url="http://159.75.43.185:8702/rtc/connect",this.msgCacheMap=new Map,this.userOpera=new a(this),this.remoteStream=new n(this)}onErr(e){}open(){}close(){}busMessage(e){}message(e){}guid(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}async connect(){const e=new RTCPeerConnection,t=e.createDataChannel("yytserver"+this.id);this.listen(e,t);const s=await this.getOffer();this._connect(s)}async getOffer(){const e=await this.localConnection.createOffer();return await this.localConnection.setLocalDescription(e),e}async setSdp(e){return this.localConnection.setRemoteDescription(e)}createMsgTags(e,t,s){const r=this.guid();this.msgCacheMap.set(r,s);const a=this.Tags(r,e,t);this.sendChannel.send(a)}createMsgUserMethod(e,t,s){const r=this.guid();this.msgCacheMap.set(r,s);const a=this.UserMethod(r,e,t);this.sendChannel.send(a)}createMsgWebrtcMethod(e,t,s){const r=this.guid();this.msgCacheMap.set(r,s);const a=this.webrtcMethod(r,e,t);this.sendChannel.send(a)}listen(e,t){t.onopen=()=>{this.open&&this.open()},t.onclose=()=>{this.onclose&&this.onclose()},t.onmessage=async e=>{const t=String.fromCharCode.apply(null,new Uint8Array(e.data)),s=decodeURIComponent(escape(t)),r=JSON.parse(s);if("2"!==r.msgType.toString()){if("1"===r.msgType.toString())return"webrtcEngine"===r.data.source.toString()&&this.remoteStream.message(r.data.data),void("tag"===r.data.source.toString()&&this.message(r.data.data));"3"!==r.msgType.toString()||this.busMessage(r.data)}else{const e=this.msgCacheMap.get(r.msgId.toString());null!=e&&(this.msgCacheMap.delete(r.msgId.toString()),e(r.data))}},e.ontrack=e=>{this.remoteStream._ontrack(e)},this.sendChannel=t,this.localConnection=e}_connect(e){const t=this.url,s=new XMLHttpRequest;s.open("POST",t,!0),s.setRequestHeader("Content-type","application/json");const r={id:this.id,sdp:JSON.stringify(e)};s.send(JSON.stringify(r)),s.onreadystatechange=()=>{if(200===s.status&&3==s.readyState){const e=s.responseText,t=JSON.parse(e);if("200"===t.code){const e=JSON.parse(t.data);this.setSdp(e)}else this.onErr(new Error(t))}else this.onErr(new Error(r))}}close(){this.localConnection.close(),this.localConnection=null,this.sendChannel=null}createStream(e){return new r(this,e)}UserOpera(){return this.userOpera}RemoteStream(){return this.remoteStream}Tags(e,t,s){const r=(new Date).Format("yyyy-MM-dd HH:mm:ss");let a={data:{clazz:"Tags",method:t,params:s,time:r,timeOut:10},msgId:e,msgType:2,time:r,version:0};return JSON.stringify(a)}UserMethod(e,t,s){const r=(new Date).Format("yyyy-MM-dd HH:mm:ss");let a={data:{clazz:"UserMethod",method:t,params:s,time:r,timeOut:10},msgId:e,msgType:2,time:r,version:0};return JSON.stringify(a)}webrtcMethod(e,t,s){const r=(new Date).Format("yyyy-MM-dd HH:mm:ss"),a={data:{clazz:"WebrtcMethod",method:t,params:s,time:r,timeOut:10},msgId:e,msgType:2,time:r,version:0};return JSON.stringify(a)}}Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var s in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+s+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[s]:("00"+t[s]).substr((""+t[s]).length)));return e},window.NewConnect=function(e){return new o(e)}}])}));
//# sourceMappingURL=yyt.min.js.map